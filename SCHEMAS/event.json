{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://ari.local/schemas/event.json",
  "title": "ARI Event Schema",
  "description": "Schema for all system events including requests, responses, decisions, and audits",
  "version": "11.0.0",
  
  "definitions": {
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp"
    },
    
    "uuid": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
      "description": "UUID v4 format"
    },
    
    "trust_level": {
      "type": "string",
      "enum": ["system", "operator", "verified", "standard", "untrusted", "hostile"]
    },
    
    "severity": {
      "type": "string",
      "enum": ["debug", "info", "warning", "error", "critical"]
    }
  },
  
  "type": "object",
  "required": ["id", "type", "timestamp", "source"],
  
  "properties": {
    "id": {
      "$ref": "#/definitions/uuid",
      "description": "Unique event identifier"
    },
    
    "type": {
      "type": "string",
      "enum": [
        "request",
        "response", 
        "decision",
        "tool_call",
        "memory_operation",
        "security_event",
        "governance_action",
        "error",
        "audit"
      ],
      "description": "Event type classification"
    },
    
    "timestamp": {
      "$ref": "#/definitions/timestamp"
    },
    
    "source": {
      "type": "object",
      "required": ["agent", "trust_level"],
      "properties": {
        "agent": {
          "type": "string",
          "description": "Agent that generated this event"
        },
        "trust_level": {
          "$ref": "#/definitions/trust_level"
        },
        "session_id": {
          "$ref": "#/definitions/uuid"
        },
        "conversation_id": {
          "$ref": "#/definitions/uuid"
        }
      }
    },
    
    "severity": {
      "$ref": "#/definitions/severity",
      "default": "info"
    },
    
    "context": {
      "type": "object",
      "properties": {
        "request_id": {
          "$ref": "#/definitions/uuid"
        },
        "parent_event_id": {
          "$ref": "#/definitions/uuid"
        },
        "correlation_id": {
          "$ref": "#/definitions/uuid"
        },
        "tags": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    
    "payload": {
      "type": "object",
      "description": "Event-specific payload data"
    },
    
    "metadata": {
      "type": "object",
      "properties": {
        "version": { "type": "string" },
        "environment": { "type": "string" },
        "processing_time_ms": { "type": "integer", "minimum": 0 },
        "token_count": {
          "type": "object",
          "properties": {
            "input": { "type": "integer", "minimum": 0 },
            "output": { "type": "integer", "minimum": 0 }
          }
        }
      }
    }
  },
  
  "allOf": [
    {
      "if": { "properties": { "type": { "const": "request" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "required": ["content"],
            "properties": {
              "content": { "type": "string" },
              "intent": { "type": "string" },
              "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
              "routed_to": { "type": "string" },
              "attachments": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "type": { "type": "string" },
                    "name": { "type": "string" },
                    "size": { "type": "integer" }
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "type": { "const": "response" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "required": ["content", "status"],
            "properties": {
              "content": { "type": "string" },
              "status": { "type": "string", "enum": ["success", "partial", "error", "blocked"] },
              "quality_score": { "type": "number", "minimum": 0, "maximum": 1 },
              "reviewed_by": { "type": "string" },
              "modifications": {
                "type": "array",
                "items": { "type": "string" }
              }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "type": { "const": "decision" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "required": ["decision_type", "outcome"],
            "properties": {
              "decision_type": { 
                "type": "string",
                "enum": ["routing", "approval", "escalation", "governance", "security"]
              },
              "outcome": { "type": "string" },
              "reasoning": { "type": "string" },
              "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
              "alternatives_considered": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "option": { "type": "string" },
                    "score": { "type": "number" }
                  }
                }
              },
              "approver": { "type": "string" }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "type": { "const": "security_event" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "required": ["security_type", "action_taken"],
            "properties": {
              "security_type": {
                "type": "string",
                "enum": ["injection_attempt", "trust_violation", "permission_denied", "rate_limit", "anomaly"]
              },
              "threat_level": { "type": "string", "enum": ["low", "medium", "high", "critical"] },
              "action_taken": { "type": "string" },
              "details": { "type": "string" },
              "blocked_content": { "type": "boolean" },
              "escalated": { "type": "boolean" }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "type": { "const": "governance_action" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "required": ["action", "actor"],
            "properties": {
              "action": {
                "type": "string",
                "enum": ["vote_cast", "override", "escalation", "review", "approval", "rejection"]
              },
              "actor": { "type": "string" },
              "target": { "type": "string" },
              "justification": { "type": "string" },
              "vote_details": {
                "type": "object",
                "properties": {
                  "in_favor": { "type": "integer" },
                  "against": { "type": "integer" },
                  "abstain": { "type": "integer" },
                  "threshold_met": { "type": "boolean" }
                }
              }
            }
          }
        }
      }
    }
  ]
}
